<!DOCTYPE html SYSTEM "http://www.thymeleaf.org/dtd/xhtml1-strict-thymeleaf-spring4-4.dtd">

<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" />
<title>Chat Support</title>
<style type="text/css">
	#messages{
		height: 150px;
		width: 450px;
		background-color: #F1F1F1;
		overflow: auto;
		float: left;
		margin-right: 20px;
	}
	#users{
		height: 150px;
		width: 150px;
		background-color: #F1F1F1;
		overflow: auto;
	}
	.message-system{
		color: red;
	}
</style>
<script type="text/javascript"
	src="https://code.jquery.com/jquery-1.11.3.js"></script>
	<script type="text/javascript">
		$.ajaxSetup({
			cache: false,
			statusCode: {
			    403: function() {
			    	appendSystem("No connection to servers");
			    },
				408: function() {
			    	appendSystem("Disconnected due to innactivity");
			    }
			}
		});
	
		$(document).ready(function(){
			$("#messageTo").keyup(function(event){
			    if(event.keyCode == 13){
			        sendMessage();
			    }
			});
		});
		
		function append(message){
			$('#messages').append('<br />'+message);
			
			var objDiv = document.getElementById("messages");
			objDiv.scrollTop = objDiv.scrollHeight;
		}
		
		/*<![CDATA[**/
		function appendSystem(message){
			var sysMessage = "<span class=\'message-system\'>"+message+"</span>";
			append(sysMessage);
		}
		/*]]>*/
		function subscribe(){
			$.ajax({
				method : "POST",
				url : "subscribe",
				data: {userName:$('#userName').val()
				}
			}).done(function(result) {
				appendSystem("Susbribed - "+result);
				readMessages();
			});
		}
		function readMessages() {
			$.ajax({
				url : "read-messages",
				data: {
					user:$('#userName').val()
				}
			}).done(function(result) {
				if(result){
					append('<i>'+result.fromUser.userName+'</i>: '+result.message);
				}
				readMessages();
			});
		};
		
		function sendMessage(){
			$.ajax({
				method : "POST",
				url : "post-message",
				data: {
					toUser:$('#sendToUser').val(),
					message:$('#messageTo').val()
				}
			}).done(function(){
				var fromUser = $('#userName').val();
				var messageTo = $("#messageTo").val();
				
				append('<i>'+fromUser+'</i>: '+messageTo);
				$("#messageTo").val('');
			});
		};
		
		function getConnectedUsers(){
			$.ajax({
				method : "GET",
				url : "connected-users",
			}).done(function(result){
				$('#users').html('Users:');
				for(var i in result){
				     $('#users').append('<br />'+result[i].userName);
				}
			});
		}
		
		function broadcast(){
			$.ajax({
				method : "POST",
				url : "broadcast-message",
				data: {
					message:$('#messageTo').val()
				}
			});
		};
	</script>
</head>
<body>
	<p th:text="#{messages.welcome}">Welcome to chat support</p>
	<section>
		User Name:
		<input id="userName" />
		<button onclick="subscribe();">Subscribe to service</button><br />
	</section>
	<hr />
	<div id="container">
		<div id="messages">Messages:</div>
		<div id="users">Users:</div>
	</div>
	<hr />
	<section>
		To user:
		<input id="sendToUser" name="userId" type="text" /> <br />
		Message:
		<input id="messageTo" name="message" type="text" /> <br />
		<button onclick="sendMessage();">Send Message</button> <br />
		<button onclick="broadcast()">Broadcast</button>
		<button onclick="getConnectedUsers()">Connected Users</button>
	</section>
</body>
</html>